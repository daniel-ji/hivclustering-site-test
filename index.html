<!doctype html>
<html>

<head>
	<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>

<body>
	Pyodide test page <br>
	Open your browser console to see Pyodide output
	<script type="text/javascript">
		const PATH_TO_PYODIDE_ROOT = "/home/pyodide/";
		const url = window.location.href;

		async function main() {
			const pyodide = await loadPyodide();
			pyodide.setDebug(true)
			console.log(pyodide.runPython(`
            import sys
            sys.version
        `));
			await pyodide.loadPackage("micropip");
			const micropip = pyodide.pyimport("micropip");

			await pyodide.loadPackage("pysam");
			console.log("pysam installed")
			await micropip.install(url + "bioext-0.21.7-cp311-cp311-emscripten_3_1_46_wasm32.whl");
			console.log("bioext installed")
			await micropip.install(url + "hyphy_python-0.1.11-cp311-cp311-emscripten_3_1_46_wasm32.whl");
			console.log("hyphy installed")
			await micropip.install(url + "fakemp-0.9.2-py3-none-any.whl");
			console.log("fakemp installed")
			await micropip.install(url + "hppy-0.9.9-py3-none-any.whl");
			console.log("hppy installed")
			await micropip.install(url + "hivclustering-1.7.0-py3-none-any.whl", keep_going = true);

			pyodide.runPython(`
			import hivclustering
			print(hivclustering.__version__)`
			);
			// load in hivnetworkcsv.py
			pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'hivnetworkcsv.py', await (await fetch(url + "hivnetworkcsv.py")).text(), { encoding: "utf8" });

			// load in data files
			pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'sequence.tn93.csv', await (await fetch(url + 'sequence.tn93.csv')).text());
			pyodide.FS.writeFile(PATH_TO_PYODIDE_ROOT + 'sequence.fasta_output.fasta', await (await fetch(url + 'sequence.fasta_output.fasta')).text());

			pyodide.globals.set("arguments", `./hivnetworkcsv.py -i sequence.tn93.csv -t 0.015 -f plain -J -q -n remove -s sequence.fasta_output.fasta`)
			pyodide.runPython(await (await fetch(url + "hivnetworkcsvweb.py")).text());
		}
		main();
	</script>
</body>

</html>